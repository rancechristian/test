stages:
  - build
  - test
  - package
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DEPLOY_SERVER: "3.101.190.84" # Your EC2 instance
  DEPLOY_USER: "ec2-user" # EC2 default user
  DEPLOY_PATH: "/home/ec2-user/webapp" # Deployment path
  GIT_STRATEGY: "none"
  GIT_CLEAN_FLAGS: "-ffdx"
  GIT_CLONE_PATH: "$CI_BUILDS_DIR/manual-clone"

cache:
  paths:
    - .m2/repository

build:
  stage: build
  tags:
    - windows
    - maven
    - java
  before_script:
    # Add hostname resolution mapping
    - echo "3.101.190.84 bb6f8136416e" >> C:\Windows\System32\drivers\etc\hosts
    # Configure Git globally
    - git config --global url."http://3.101.190.84/".insteadOf "http://bb6f8136416e/"
    - git config --global http.sslVerify false
    - git config --global http.lowSpeedLimit 0
    - git config --global http.lowSpeedTime 999999
    # Manual clone with correct URL
    - if (Test-Path ".git") { Remove-Item -Recurse -Force ".git" }
    - git clone --depth 20 http://3.101.190.84/root/terraform-maven.git temp-repo
    - Move-Item temp-repo/.git .
    - Remove-Item -Recurse -Force temp-repo
    - git reset --hard HEAD
  script:
    - mvn clean compile
  artifacts:
    paths:
      - target/*.war

test:
  stage: test
  tags:
    - windows
    - maven
    - java
  before_script:
    # Add hostname resolution mapping
    - echo "3.101.190.84 bb6f8136416e" >> C:\Windows\System32\drivers\etc\hosts
    - git config --global url."http://3.101.190.84/".insteadOf "http://bb6f8136416e/"
    - git config --global http.sslVerify false
  script:
    - mvn test

package:
  stage: package
  tags:
    - windows
    - maven
    - java
  before_script:
    # Add hostname resolution mapping
    - echo "3.101.190.84 bb6f8136416e" >> C:\Windows\System32\drivers\etc\hosts
    - git config --global url."http://3.101.190.84/".insteadOf "http://bb6f8136416e/"
    - git config --global http.sslVerify false
  script:
    - mvn package
  artifacts:
    paths:
      - target/*.war

# Deploy to Tomcat on EC2 instance
deploy:
  stage: deploy
  tags:
    - windows
    - maven
    - java
  script:
    - echo "Deploying to Tomcat on $DEPLOY_SERVER..."
    - |
      if (Test-Path "target\*.war") {
        echo "WAR file found for deployment."
        $warFile = Get-ChildItem target\*.war | Select-Object -First 1
        echo "WAR file: $($warFile.Name)"
        
        # Copy WAR file to EC2 instance
        scp -i pair08.pem target\*.war ${env:DEPLOY_USER}@${env:DEPLOY_SERVER}:/tmp/
        
        # Deploy to Tomcat container
        ssh -i pair08.pem ${env:DEPLOY_USER}@${env:DEPLOY_SERVER} "sudo docker cp /tmp/*.war tomcat:/usr/local/tomcat/webapps/"
        
        echo "Deployment completed to: http://${env:DEPLOY_SERVER}:8080/terraform-maven"
      } else {
        echo "No WAR file found!"
        exit 1
      }
  artifacts:
    paths:
      - target/*.war
  only:
    - main
  when: manual
