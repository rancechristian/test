# GitLab CI/CD Pipeline for Maven Projects
# This file should be placed in your project root as .gitlab-ci.yml

stages:
  - build
  - test
  - package
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DEPLOY_SERVER: "3.101.190.84" # Your EC2 instance
  DEPLOY_USER: "ec2-user" # EC2 default user
  DEPLOY_PATH: "/home/ec2-user/webapp" # Deployment path
  TOMCAT_WEBAPPS: "/usr/local/tomcat/webapps"

cache:
  paths:
    - .m2/repository

# Build stage - Compile the source code
build:
  stage: build
  tags:
    - windows
    - maven
    - java
  script:
    - echo "Starting Maven build..."
    - mvn clean compile
    - echo "Build completed successfully"
  artifacts:
    paths:
      - target/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# Test stage - Run unit tests
test:
  stage: test
  tags:
    - windows
    - maven
    - java
  script:
    - echo "Running Maven tests..."
    - mvn test
    - echo "Tests completed"
  artifacts:
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    paths:
      - target/surefire-reports/
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  only:
    - main
    - develop
    - merge_requests

# Package stage - Create WAR file
package:
  stage: package
  tags:
    - windows
    - maven
    - java
  script:
    - echo "Creating Maven package..."
    - mvn package -DskipTests
    - echo "Package created successfully"
    - dir target\*.war
  artifacts:
    paths:
      - target/*.war
    expire_in: 1 week
  only:
    - main
    - develop

# Deploy stage - Deploy to Tomcat on EC2 (manual trigger)
deploy:
  stage: deploy
  tags:
    - windows
    - maven
    - java
  script:
    - echo "Deploying to Tomcat on $DEPLOY_SERVER..."
    - |
      if (Test-Path "target\*.war") {
        echo "WAR file found, ready for deployment"
        $warFile = Get-ChildItem target\*.war | Select-Object -First 1
        echo "WAR file: $($warFile.Name)"
        
        # Copy WAR file to EC2 instance
        echo "Copying WAR file to EC2 instance..."
        scp -i pair08.pem target\*.war ${env:DEPLOY_USER}@${env:DEPLOY_SERVER}:/tmp/
        
        # Deploy to Tomcat container
        echo "Deploying to Tomcat container..."
        $deployScript = @"
          echo 'Connected to EC2 instance'
          
          # Stop any existing app with same name
          sudo docker exec tomcat rm -f ${env:TOMCAT_WEBAPPS}/maven-challenge*.war 2>/dev/null || true
          sudo docker exec tomcat rm -rf ${env:TOMCAT_WEBAPPS}/maven-challenge* 2>/dev/null || true
          
          # Copy new WAR file to Tomcat container
          sudo docker cp /tmp/*.war tomcat:${env:TOMCAT_WEBAPPS}/
          
          # Verify deployment
          sleep 5
          sudo docker exec tomcat ls -la ${env:TOMCAT_WEBAPPS}/
          
          echo 'Deployment completed successfully'
"@
        
        ssh -i pair08.pem ${env:DEPLOY_USER}@${env:DEPLOY_SERVER} $deployScript
        
        echo "Application deployed to: http://${env:DEPLOY_SERVER}:8080/maven-challenge"
        echo "Deployment completed successfully"
      } else {
        echo "No WAR file found!"
        exit 1
      }
  environment:
    name: production
    url: http://$DEPLOY_SERVER:8080/maven-challenge
  only:
    - main
  when: manual
  allow_failure: false

# Optional: Code quality check
code_quality:
  stage: test
  tags:
    - windows
    - maven
    - java
  script:
    - echo "Running code quality checks..."
    - mvn checkstyle:check
  allow_failure: true
  only:
    - merge_requests
    - main

# Optional: Security scan
security_scan:
  stage: test
  tags:
    - windows
    - maven
    - java
  script:
    - echo "Running security scan..."
    - mvn dependency-check:check
  artifacts:
    reports:
      dependency_scanning: target/dependency-check-report.xml
  allow_failure: true
  only:
    - main
    - schedules