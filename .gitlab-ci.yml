stages:
  - build
  - test
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DEPLOY_SERVER: "3.101.190.84"
  DEPLOY_USER: "ec2-user"
  GIT_STRATEGY: "none"

cache:
  paths:
    - .m2/repository

# Setup script for Maven and Git
.setup_environment: &setup_environment
  before_script:
    # Download and setup Maven if not exists
    - |
      if (!(Test-Path "C:\maven\apache-maven-3.9.4\bin\mvn.cmd")) {
        Write-Host "Downloading Apache Maven..." -ForegroundColor Yellow
        if (!(Test-Path "C:\maven")) { New-Item -ItemType Directory -Path "C:\maven" -Force }
        Invoke-WebRequest -Uri "https://archive.apache.org/dist/maven/maven-3/3.9.4/binaries/apache-maven-3.9.4-bin.zip" -OutFile "C:\maven\maven.zip"
        Expand-Archive -Path "C:\maven\maven.zip" -DestinationPath "C:\maven" -Force
        Remove-Item "C:\maven\maven.zip" -Force
        Write-Host "Maven installed successfully" -ForegroundColor Green
      }
    # Add Maven to PATH for this session
    - $env:PATH = "C:\maven\apache-maven-3.9.4\bin;$env:PATH"
    - $env:M2_HOME = "C:\maven\apache-maven-3.9.4"
    # Set up Git hostname resolution (use user temp directory to avoid admin rights)
    - $hostsFile = "$env:TEMP\hosts_addon"
    - echo "3.101.190.84 bb6f8136416e" > $hostsFile
    - git config --global url."http://3.101.190.84/".insteadOf "http://bb6f8136416e/"
    - git config --global http.sslVerify false
    # Clone repository
    - if (Test-Path ".git") { Remove-Item -Recurse -Force ".git" }
    - git clone --depth 20 http://3.101.190.84/root/terraform-maven.git temp-repo
    - Move-Item temp-repo/.git . -Force
    - Remove-Item -Recurse -Force temp-repo
    - git reset --hard HEAD
    # Verify Maven installation
    - mvn --version

build:
  <<: *setup_environment
  stage: build
  tags:
    - windows
    - maven
    - java
  script:
    - mvn clean compile
  artifacts:
    paths:
      - target/

test:
  <<: *setup_environment
  stage: test
  tags:
    - windows
    - maven
    - java
  script:
    - mvn test

deploy:
  stage: deploy
  tags:
    - windows
    - maven
    - java
  before_script:
    # Download and setup Maven if not exists
    - |
      if (!(Test-Path "C:\maven\apache-maven-3.9.4\bin\mvn.cmd")) {
        Write-Host "Downloading Apache Maven..." -ForegroundColor Yellow
        if (!(Test-Path "C:\maven")) { New-Item -ItemType Directory -Path "C:\maven" -Force }
        Invoke-WebRequest -Uri "https://archive.apache.org/dist/maven/maven-3/3.9.4/binaries/apache-maven-3.9.4-bin.zip" -OutFile "C:\maven\maven.zip"
        Expand-Archive -Path "C:\maven\maven.zip" -DestinationPath "C:\maven" -Force
        Remove-Item "C:\maven\maven.zip" -Force
        Write-Host "Maven installed successfully" -ForegroundColor Green
      }
    # Add Maven to PATH for this session
    - $env:PATH = "C:\maven\apache-maven-3.9.4\bin;$env:PATH"
    - $env:M2_HOME = "C:\maven\apache-maven-3.9.4"
    # Set up hostname resolution (using environment variables instead of hosts file)
    - $env:DEPLOY_SERVER_IP = "3.101.190.84"
    # Copy SSH key to working directory
    - Copy-Item "c:\Users\rance.c.v.linezo\Desktop\terraform\pair08.pem" ".\pair08.pem" -Force
    # Set proper permissions for SSH key
    - icacls ".\pair08.pem" /inheritance:r /grant:r "$env:USERNAME:R"
  script:
    - mvn package -DskipTests
    - |
      if (Test-Path "target\*.war") {
        $warFile = Get-ChildItem target\*.war | Select-Object -First 1
        echo "Deploying: $($warFile.Name)"
        echo "Copying WAR file to server..."
        scp -i .\pair08.pem target\*.war ${env:DEPLOY_USER}@${env:DEPLOY_SERVER}:/tmp/
        echo "Deploying to Tomcat container..."
        ssh -i .\pair08.pem ${env:DEPLOY_USER}@${env:DEPLOY_SERVER} "sudo docker cp /tmp/*.war tomcat:/usr/local/tomcat/webapps/"
        echo "Deployed to: http://${env:DEPLOY_SERVER}:8080/maven-challenge"
        echo "Application should be accessible in a few moments..."
      } else {
        echo "No WAR file found in target directory"
        exit 1
      }
  only:
    - main